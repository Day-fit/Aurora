services:
  aurora-core:
    image: 'ghcr.io/day-fit/aurora-core:latest'
    container_name: core
    restart: unless-stopped
    healthcheck:
      test: [ 'CMD', 'curl', '-f', 'http://localhost:8081/actuator/health' ]
      retries: 3
      timeout: 5s
      interval: 10s
    ports:
      - '8081:8081'
    depends_on:
      - postgres
      - redis
      - minio
      - rabbitmq
      - aurora-ai
      - aurora-auth
    environment:
      - 'RABBITMQ_HOST=${RABBITMQ_HOST}'
      - 'RABBITMQ_USER=${RABBITMQ_USER}'
      - 'RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}'
      - 'DB_USER=${DB_USER}'
      - 'DB_PASSWORD=${DB_PASSWORD}'
      - 'DB_URL=${DB_URL}'
      - 'DB_NAME=${DB_NAME}'
      - 'JWKS_SUPPLIER_URI=${JWKS_SUPPLIER_URI}'
      - 'CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}'
      - 'GITHUB_PAT=${GITHUB_PAT}'
      - 'MINIO_HOST=${MINIO_HOST}'
      - 'MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}'
      - 'MINIO_SECRET_KEY=${MINIO_SECRET_KEY}'
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'
      - 'com.centurylinklabs.watchtower.reboot-if-changed=true'
    profiles:
      - prod

  aurora-auth:
    image: 'ghcr.io/day-fit/aurora-auth:latest'
    container_name: auth
    restart: unless-stopped
    healthcheck:
      test: [ 'CMD', 'curl', '-f', 'http://localhost:8083/actuator/health' ]
      retries: 3
      timeout: 5s
      interval: 10s
    depends_on:
      - postgres
      - rabbitmq
      - minio
      - redis
    ports:
      - '8083:8083'
    environment:
      - 'RABBITMQ_HOST=${RABBITMQ_HOST}'
      - 'RABBITMQ_USER=${RABBITMQ_USER}'
      - 'RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}'
      - 'DB_USER=${DB_USER}'
      - 'DB_PASSWORD=${DB_PASSWORD}'
      - 'DB_URL=${DB_URL}'
      - 'DB_NAME=${DB_NAME}'
      - 'MINIO_HOST=${MINIO_HOST}'
      - 'MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}'
      - 'MINIO_SECRET_KEY=${MINIO_SECRET_KEY}'
      - 'REDIS_HOST=${REDIS_HOST}'
      - 'REDIS_PASSWORD=${REDIS_PASSWORD}'
      - 'GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}'
      - 'GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}'
      - 'GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}'
      - 'GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}'
      - 'JWKS_SUPPLIER_URI=${JWKS_SUPPLIER_URI}'
      - 'CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}'
      - 'GITHUB_PAT=${GITHUB_PAT}'
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'
      - 'com.centurylinklabs.watchtower.reboot-if-changed=true'
    profiles:
      - prod

  aurora-ai:
    image: 'ghcr.io/day-fit/aurora-ai:latest'
    container_name: ai
    ports:
      - '8082:8082'
    restart: unless-stopped
    depends_on:
      - rabbitmq
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8082/actuator/health']
      retries: 3
      timeout: 5s
      interval: 10s
    environment:
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
      - 'OPENAI_ORGANIZATION=${OPENAI_ORGANIZATION}'
      - 'OPENAI_PROJECT=${OPENAI_PROJECT}'
      - 'RABBITMQ_HOST=${RABBITMQ_HOST}'
      - 'RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}'
      - 'RABBITMQ_USER=${RABBITMQ_USER}'
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'
      - 'com.centurylinklabs.watchtower.reboot-if-changed=true'
    profiles:
      - prod

  aurora-frontend:
    image: 'ghcr.io/day-fit/aurora-frontend:latest'
    container_name: frontend
    ports:
      - '3000:3000'
    restart: unless-stopped
    healthcheck:
      test: [ 'CMD', 'curl', '-f', 'http://localhost:3000' ]
      retries: 3
      timeout: 5s
      interval: 10s
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'
      - 'com.centurylinklabs.watchtower.reboot-if-changed=true'
    depends_on:
      - aurora-core
      - aurora-auth
      - aurora-ai
    environment:
      - 'BACKEND_AUTH_URL=${BACKEND_AUTH_URL}'
      - 'BACKEND_CORE_URL=${BACKEND_CORE_URL}'
      - 'NEXT_PUBLIC_BACKEND_CORE_URL=${NEXT_PUBLIC_BACKEND_CORE_URL}'
      - 'NEXT_PUBLIC_BACKEND_AUTH_URL=${NEXT_PUBLIC_BACKEND_AUTH_URL}'
    profiles:
      - prod

  postgres:
    image: 'postgres:latest'
    environment:
      - 'POSTGRES_DB=${DB_NAME}'
      - 'POSTGRES_PASSWORD=${DB_PASSWORD:-secret}'
      - 'POSTGRES_USER=${DB_USER}'
    volumes:
      - postgres:/var/lib/postgresql
    ports:
      - '5432:5432'

  redis:
    image: 'redis:latest'
    environment:
      - 'REDIS_PASSWORD=${REDIS_PASSWORD}'
    ports:
      - '6379:6379'
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'

  minio:
    image: minio/minio:latest
    environment:
      - 'MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}'
      - 'MINIO_SECRET_KEY=${MINIO_SECRET_KEY}'
    ports:
      - '9000:9000'
      - '9090:9090'
    command: [ "server", "--console-address", ":9090", "/data"]
    volumes:
      - minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 5s
      timeout: 2s
      retries: 12
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'

  create-buckets:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      sh -c "
        mc alias set local http://minio:9000 ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY} &&
        mc mb -p local/jwks || true &&
        mc mb -p local/resumes || true
      "
    restart: 'no'

  rabbitmq:
    image: 'rabbitmq:4.1.0-management-alpine'
    ports:
      - '5672:5672'
      - '15672:15672'
      - '5552:5552'
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./definitions.json:/etc/rabbitmq/definitions.json:ro
      - rabbitmq:/var/lib/rabbitmq
    command: >
      bash -c "rabbitmq-plugins enable --offline rabbitmq_stream && rabbitmq-server"
    profiles:
      - 'prod'
    labels:
      - 'com.centurylinklabs.watchtower.enable=true'

  rabbitmq-dev:
    image: 'rabbitmq:4.1.0-management-alpine'
    ports:
      - "5672:5672"
      - "15672:15672"
      - "5552:5552"
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./definitions-dev.json:/etc/rabbitmq/definitions.json:ro
      - rabbitmq_dev:/var/lib/rabbitmq
    command: >
      bash -c "rabbitmq-plugins enable --offline rabbitmq_stream && rabbitmq-server"
    profiles:
      - 'dev'

  nginx:
    image: nginx:mainline-alpine3.20-perl
    restart: unless-stopped
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      certbot-init:
        condition: service_completed_successfully
      aurora-frontend:
        condition: service_started
      aurora-core:
        condition: service_started
      aurora-auth:
        condition: service_started
    ports:
      - '80:80'
      - '443:443'
    profiles:
      - 'prod'

  certbot:
    image: certbot/certbot:v5.2.2
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: >
      sh -c "trap exit TERM;
      while :; do
        certbot renew --webroot -w /var/www/certbot --quiet;
        sleep 12h;
      done"
    profiles:
      - prod

  certbot-init:
    image: alpine:3.20
    volumes:
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: >
      sh -c '
      CERT="/etc/letsencrypt/live/example.com/fullchain.pem";
      if [ ! -f "$CERT" ]; then
        apk add --no-cache openssl >/dev/null;
        mkdir -p /etc/letsencrypt/live/example.com;
        openssl req -x509 -nodes -newkey rsa:2048 \
          -days 1 \
          -keyout /etc/letsencrypt/live/example.com/privkey.pem \
          -out /etc/letsencrypt/live/example.com/fullchain.pem \
          -subj "/CN=example.com";
      fi
      '
    profiles:
      - 'prod'

  watchtower:
    image: containrrr/watchtower:1.7.1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - "DOCKER_API_VERSION=1.44"
    command: --label-enable --cleanup --interval 30
    restart: unless-stopped
    profiles:
      - 'prod'

volumes:
  postgres:
  minio:
  rabbitmq:
  rabbitmq_dev:

